(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))u(s);new MutationObserver(s=>{for(const e of s)if(e.type==="childList")for(const a of e.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&u(a)}).observe(document,{childList:!0,subtree:!0});function h(s){const e={};return s.integrity&&(e.integrity=s.integrity),s.referrerPolicy&&(e.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?e.credentials="include":s.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function u(s){if(s.ep)return;s.ep=!0;const e=h(s);fetch(s.href,e)}})();var _=typeof Float32Array<"u"?Float32Array:Array;Math.hypot||(Math.hypot=function(){for(var i=0,o=arguments.length;o--;)i+=arguments[o]*arguments[o];return Math.sqrt(i)});function A(){var i=new _(2);return _!=Float32Array&&(i[0]=0,i[1]=0),i}function R(i){var o=new _(2);return o[0]=i[0],o[1]=i[1],o}function C(i,o){var h=new _(2);return h[0]=i,h[1]=o,h}function k(i,o){return i[0]=o[0],i[1]=o[1],i}function D(i,o,h){return i[0]=o,i[1]=h,i}function Z(i,o,h){return i[0]=o[0]+h[0],i[1]=o[1]+h[1],i}function F(i,o,h){return i[0]=o[0]-h[0],i[1]=o[1]-h[1],i}function $(i,o,h){return i[0]=o[0]*h,i[1]=o[1]*h,i}function L(i,o,h,u){return i[0]=o[0]+h[0]*u,i[1]=o[1]+h[1]*u,i}function M(i,o){var h=o[0]-i[0],u=o[1]-i[1];return Math.hypot(h,u)}function w(i,o){var h=o[0],u=o[1],s=h*h+u*u;return s>0&&(s=1/Math.sqrt(s)),i[0]=o[0]*s,i[1]=o[1]*s,i}function N(i,o){return i[0]*o[0]+i[1]*o[1]}var P=F,G=M;(function(){var i=A();return function(o,h,u,s,e,a){var t,r;for(h||(h=2),u||(u=0),s?r=Math.min(s*h+u,o.length):r=o.length,t=u;t<r;t+=h)i[0]=o[t],i[1]=o[t+1],e(i,i,a),o[t]=i[0],o[t+1]=i[1];return o}})();var V;(i=>{function o(){const h=u=>{const c={with:(p,n)=>h({...u,[p]:n}),addPlayer:p=>{const n=I.makePlayer(p);return h({...u,player:n})},addEntity:p=>{const n=u.entities??[],d=I.makeEntity(p,`entity_${n.length+1}`),y=[...n,d];return h({...u,entities:y})},addMirror:(p,n)=>{const d=u.mirrors??[],y={start:R(p),end:R(n),id:`mirror_${d.length+1}`},g=[...d,y];return h({...u,mirrors:g})},setBounds:p=>h({...u,bounds:R(p)})};return"player"in u&&"entities"in u&&"mirrors"in u?{...c,build:()=>({...u,bounds:u.bounds||C(800,600)})}:c};return h({})}i.make=o})(V||(V={}));var I;(i=>{function o(a){return{tag:"player",position:a}}i.makePlayer=o;function h([a,t],r){return{tag:"entity",id:r,position:C(a,t),vertices:[C(a,t-i.ENTITY_SIZE),C(a-i.ENTITY_SIZE,t+i.ENTITY_SIZE),C(a+i.ENTITY_SIZE,t+i.ENTITY_SIZE)]}}i.makeEntity=h,i.PLAYER_RADIUS=12,i.ENTITY_SIZE=8,i.MIRROR_SIZE=10;function u([a,t],r){return{id:r,start:C(a-i.MIRROR_SIZE,t),end:C(a+i.MIRROR_SIZE,t)}}i.makeMirror=u;function s(a){return a.entities}i.getAllEntities=s;function e(a,t){return t==="player"?a.player:a.entities.find(r=>r.id===t)||null}i.findEntityById=e})(I||(I={}));var O;(i=>{class h{constructor(s,e,a={gridSize:128,snapDistance:10}){this.onChange=e,this.canvas=s,this.quantizeConfig=a,this.state={dragState:null,selectedEntity:null,mousePosition:A(),pendingActions:[],isMouseDown:!1,showRays:!0,showVirtualImages:!0},this.setupEventListeners(),this.createGUI()}state;canvas;quantizeConfig;entities=[];player=null;batchTimer=null;batchDelayMs=1;setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this))}getCanvasCoordinates(s){const e=this.canvas.getBoundingClientRect();return C(s.clientX-e.left,s.clientY-e.top)}findEntityAtPosition(s){if(this.player){const e=M(s,this.player.position);if(console.log("Player distance:",e,"threshold:",I.PLAYER_RADIUS),e<=I.PLAYER_RADIUS)return this.player}for(const e of this.entities){const a=M(s,e.position);if(console.log("Entity",e.id,"distance:",a,"threshold:",20),a<=20)return e}return null}handleMouseDown(s){const e=this.getCanvasCoordinates(s);k(this.state.mousePosition,e),this.state.isMouseDown=!0;const a=this.findEntityAtPosition(e);if(a){const t=a.tag==="player"?"player":a.id;this.addAction({type:"SELECT_ENTITY",entityId:t}),this.addAction({type:"START_DRAG",entityId:t,position:e}),console.log("MOUSE POS:"),console.log(e)}else this.addAction({type:"DESELECT_ALL"})}handleMouseMove(s){const e=this.getCanvasCoordinates(s);k(this.state.mousePosition,e),this.state.isMouseDown&&this.state.dragState&&this.addAction({type:"UPDATE_DRAG",position:e})}handleMouseUp(){this.state.isMouseDown=!1,this.state.dragState&&(this.addAction({type:"MOVE_ENTITY",entityId:this.state.dragState.entityId,position:this.state.mousePosition}),this.addAction({type:"END_DRAG"}))}handleMouseLeave(){this.state.isMouseDown=!1,this.state.dragState&&this.addAction({type:"END_DRAG"})}addAction(s){console.log(`ACTION: ${s.type}`),this.state.pendingActions.push(s),this.scheduleBatchedOnChange()}scheduleBatchedOnChange(){this.batchTimer!==null&&clearTimeout(this.batchTimer),this.batchTimer=setTimeout(()=>{if(this.batchTimer=null,this.state.pendingActions.length>0){const s=[...this.state.pendingActions];this.state.pendingActions=[],this.onChange(s)}},this.batchDelayMs)}addEntity(){this.addActionImmediate({type:"ADD_OBJECT"})}runSimulation(){this.addActionImmediate({type:"RUN_SIMULATION"})}refreshScene(){this.addActionImmediate({type:"REFRESH_SCENE"})}addActionImmediate(s){this.state.pendingActions.push(s),this.flushPendingActions()}updateEntities(s,e){this.entities=s,this.player=e}getAndClearActions(){const s=[...this.state.pendingActions];return this.state.pendingActions=[],s}flushPendingActions(){if(this.batchTimer!==null&&(clearTimeout(this.batchTimer),this.batchTimer=null),this.state.pendingActions.length>0){const s=[...this.state.pendingActions];this.state.pendingActions=[],this.onChange(s),s.forEach(e=>this.updateState(e))}}updateState(s){switch(s.type){case"SELECT_ENTITY":s.entityId==="player"?this.state.selectedEntity=this.player:this.state.selectedEntity=this.entities.find(e=>e.id===s.entityId)||null;break;case"DESELECT_ALL":this.state.selectedEntity=null;break;case"START_DRAG":this.state.dragState={entityId:s.entityId,entityType:s.entityId=="player"?"player":"entity",startPosition:R(s.position),currentPosition:R(s.position),isDragging:!0};break;case"UPDATE_DRAG":this.state.dragState&&k(this.state.dragState.currentPosition,s.position);break;case"END_DRAG":this.state.dragState=null;break}}getSelectedEntity(){return this.state.selectedEntity}getDragState(){return this.state.dragState}getMousePosition(){return this.state.mousePosition}setValidPositions(s){this.quantizeConfig.validPositions=s}getDragPreviewPosition(){return this.state.dragState?.currentPosition??null}getShowRays(){return this.state.showRays}getShowVirtualImages(){return this.state.showVirtualImages}setShowRays(s){this.state.showRays=s,this.triggerRender()}setShowVirtualImages(s){this.state.showVirtualImages=s,this.triggerRender()}triggerRender(){this.onChange([])}destroy(){this.batchTimer!==null&&(clearTimeout(this.batchTimer),this.batchTimer=null),this.canvas.removeEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.removeEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.removeEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.removeEventListener("mouseleave",this.handleMouseLeave.bind(this))}createGUI(){const s=document.createElement("div");s.className="gui-container";const e=document.createElement("button");e.className="gui-button",e.textContent="Add Object",e.onclick=()=>this.addEntity(),s.appendChild(e);const a=document.createElement("button");a.className="gui-button gui-button-secondary",a.textContent="Refresh Scene",a.onclick=()=>this.refreshScene(),s.appendChild(a);const t=document.createElement("div");t.className="gui-checkbox-container";const r=document.createElement("input");r.type="checkbox",r.id="show-rays",r.className="gui-checkbox",r.checked=this.state.showRays,r.onchange=()=>this.setShowRays(r.checked);const c=document.createElement("label");c.htmlFor="show-rays",c.className="gui-checkbox-label",c.textContent="Show Rays",t.appendChild(r),t.appendChild(c),s.appendChild(t);const p=document.createElement("div");p.className="gui-checkbox-container";const n=document.createElement("input");n.type="checkbox",n.id="show-virtual-images",n.className="gui-checkbox",n.checked=this.state.showVirtualImages,n.onchange=()=>this.setShowVirtualImages(n.checked);const d=document.createElement("label");d.htmlFor="show-virtual-images",d.className="gui-checkbox-label",d.textContent="Show Virtual Images",p.appendChild(n),p.appendChild(d),s.appendChild(p),document.body.appendChild(s)}}i.Handler=h})(O||(O={}));var Y;(i=>{function u(n,d,y,g){const f=A();P(f,g,y);const E=A();P(E,y,n);const l=d[0]*f[1]-d[1]*f[0];if(Math.abs(l)<1e-6)return null;const T=(E[0]*f[1]-E[1]*f[0])/l;if(T<1e-6)return null;const S=(E[0]*d[1]-E[1]*d[0])/l;if(S<0||S>1)return null;const b=A();L(b,n,d,T);const v=A();return D(v,-f[1],f[0]),w(v,v),{point:b,distance:T,normal:v}}function s(n,d,y,g){const f=A();P(f,y,n);const E=N(f,d);if(E<0)return null;const l=A();$(l,d,E);const m=A();Z(m,n,l);const T=M(m,y);if(T>g)return null;const x=Math.sqrt(g*g-T*T),S=E-x;if(S<1e-6)return null;const b=A();L(b,n,d,S);const v=A();return P(v,b,y),w(v,v),{point:b,distance:S,normal:v}}function e(n,d){const y=A(),g=N(n,d);return L(y,n,d,-2*g),y}function a(n,d,y){const[g,f,E]=y;for(let l=0;l<3;l++){const m=y[l],T=y[(l+1)%3],x=u(n,d,m,T);if(x){const S=A(),b=A(),v=A();return P(b,f,g),P(v,E,g),b[0]*v[1]-b[1]*v[0]>0?D(S,v[1]-b[1],b[0]-v[0]):D(S,b[1]-v[1],v[0]-b[0]),w(S,S),{point:x.point,distance:x.distance,normal:S}}}return null}function t(n,d,y,g=!1){let f=null,E=1/0;for(const l of y.mirrors){const m=u(n,d,l.start,l.end);m&&m.distance<E&&(m.mirrorId=l.id,f=m,E=m.distance)}if(!g){const l=s(n,d,y.player.position,I.PLAYER_RADIUS);l&&l.distance<E&&(f=l,E=l.distance)}for(const l of y.entities){const m=a(n,d,l.vertices);m&&m.distance<E&&(m.entityId=l.id,f=m,E=m.distance)}return f}function r(n,d,y,g=10){const f={origin:R(n),direction:R(d),history:[R(n)]};let E=R(n),l=R(d),m=0,T=!1;for(;m<g;){const x=t(E,l,y,!0);if(!x)break;if(f.history.push(R(x.point)),x.mirrorId){T=!0;const S=e(l,x.normal);E=R(x.point),l=S,m++}else{if(T&&x.entityId)return f.entityId=x.entityId,f;break}}return null}function c(n){return n.history[n.history.length-1]}function p(n){const d=[];for(let g=0;g<128;g++){const f=g/128*Math.PI*2,E=C(Math.cos(f),Math.sin(f)),l=r(n.player.position,E,n);l&&l.history.length>1&&l.entityId&&d.push(l)}return n.entities.map(g=>d.filter(f=>f.entityId===g.id).sort((f,E)=>{const l=G(c(f),g.position),m=G(c(E),g.position);return l-m})[0]).filter(Boolean)}i.trace=p})(Y||(Y={}));var U;(i=>{const o={PLAYER:"#2563eb",PLAYER_SELECTED:"#1d4ed8",OBJECT:"#dc2626",OBJECT_SELECTED:"#b91c1c",MIRROR:"#a5b4fc",RAY:"#fbbf24",VIRTUAL_IMAGE:"#6b7280",DRAG_PREVIEW:"#10b981",BACKGROUND:"#ffffff"};class h{ctx;canvas;options;constructor(e,a={}){this.canvas=e;const t=e.getContext("2d");if(!t)throw new Error("Failed to get 2D rendering context");this.ctx=t,this.options={showRays:!0,showVirtualImages:!0,...a},this.setupCanvas()}setupCanvas(){const e=this.canvas.getBoundingClientRect();this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.imageSmoothingEnabled=!0,this.ctx.lineCap="round",this.ctx.lineJoin="round"}render(e,a=null,t=null,r=null){this.clearCanvas(),this.renderMirrors(e.mirrors),e.rays.length>0&&this.renderRays(e.rays),e.virtualImages.length>0&&this.renderVirtualImages(e.virtualImages),this.renderObjects(e.entities,a),this.renderPlayer(e.player,a),t&&r&&this.renderDragPreview(t,r)}clearCanvas(){this.ctx.fillStyle=o.BACKGROUND,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}renderPlayer(e,a){const t=a?.tag==="player";this.ctx.fillStyle=t?o.PLAYER_SELECTED:o.PLAYER,this.ctx.strokeStyle=t?o.PLAYER_SELECTED:o.PLAYER,this.ctx.lineWidth=2,this.ctx.beginPath(),this.ctx.arc(e.position[0],e.position[1],I.PLAYER_RADIUS,0,2*Math.PI),this.ctx.fill(),t&&(this.ctx.strokeStyle=o.PLAYER_SELECTED,this.ctx.lineWidth=3,this.ctx.setLineDash([5,5]),this.ctx.beginPath(),this.ctx.arc(e.position[0],e.position[1],I.PLAYER_RADIUS+5,0,2*Math.PI),this.ctx.stroke(),this.ctx.setLineDash([]))}renderObjects(e,a){for(const t of e)this.renderTriangle(t,a?.tag==="entity"&&a?.id===t.id)}renderTriangle(e,a){this.ctx.fillStyle=a?o.OBJECT_SELECTED:o.OBJECT,this.ctx.strokeStyle=a?o.OBJECT_SELECTED:o.OBJECT,this.ctx.lineWidth=2;const[t,r,c]=e.vertices;this.ctx.beginPath(),this.ctx.moveTo(t[0],t[1]),this.ctx.lineTo(r[0],r[1]),this.ctx.lineTo(c[0],c[1]),this.ctx.closePath(),this.ctx.fill(),a&&(this.ctx.strokeStyle=o.OBJECT_SELECTED,this.ctx.lineWidth=3,this.ctx.setLineDash([5,5]),this.ctx.stroke(),this.ctx.setLineDash([]))}renderMirrors(e){this.ctx.strokeStyle=o.MIRROR,this.ctx.lineWidth=4,this.ctx.lineCap="round";for(const a of e)this.ctx.beginPath(),this.ctx.moveTo(a.start[0],a.start[1]),this.ctx.lineTo(a.end[0],a.end[1]),this.ctx.stroke()}renderRays(e){for(const a of e){if(a.history.length<2)continue;const t=a.history.length-1;for(let r=0;r<t;r++){const c=o.RAY;this.ctx.strokeStyle=this.addAlpha(c,1),this.ctx.lineWidth=4,this.ctx.beginPath(),this.ctx.moveTo(a.history[r][0],a.history[r][1]),this.ctx.lineTo(a.history[r+1][0],a.history[r+1][1]),this.ctx.stroke()}}}renderVirtualImages(e){for(const a of e){if(!a.isVisible)continue;const t=Math.max(.3,1-a.bounces*.1);this.ctx.fillStyle=this.addAlpha(o.VIRTUAL_IMAGE,t),this.ctx.strokeStyle=this.addAlpha(o.VIRTUAL_IMAGE,t),this.ctx.lineWidth=1,this.ctx.setLineDash([2,2]);const r=10,c=a.position[0],p=a.position[1];this.ctx.beginPath(),this.ctx.moveTo(c,p-r),this.ctx.lineTo(c-r,p+r),this.ctx.lineTo(c+r,p+r),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()}this.ctx.setLineDash([])}renderDragPreview(e,a){this.ctx.fillStyle=this.addAlpha(o.DRAG_PREVIEW,.7),this.ctx.strokeStyle=o.DRAG_PREVIEW,this.ctx.lineWidth=2,this.ctx.setLineDash([5,5]);const t=a[0],r=a[1];e.entityId==="player"?(this.ctx.beginPath(),this.ctx.arc(e.currentPosition[0],e.currentPosition[1],I.PLAYER_RADIUS,0,2*Math.PI),this.ctx.stroke(),this.ctx.closePath()):(this.ctx.beginPath(),this.ctx.moveTo(t,r-I.ENTITY_SIZE),this.ctx.lineTo(t-I.ENTITY_SIZE,r+I.ENTITY_SIZE),this.ctx.lineTo(t+I.ENTITY_SIZE,r+I.ENTITY_SIZE),this.ctx.closePath(),this.ctx.fill(),this.ctx.stroke()),this.ctx.setLineDash([])}addAlpha(e,a){const t=e.replace("#",""),r=parseInt(t.substr(0,2),16),c=parseInt(t.substr(2,2),16),p=parseInt(t.substr(4,2),16);return`rgba(${r}, ${c}, ${p}, ${a})`}setOptions(e){this.options={...this.options,...e}}getCanvasSize(){return{width:this.canvas.width,height:this.canvas.height}}resize(){this.setupCanvas()}}i.Renderer=h;function u(s,e){return new h(s,e)}i.make=u})(U||(U={}));var B;(i=>{function o(t,r){const c=A();P(c,r.end,r.start),w(c,c);const p=A();D(p,-c[1],c[0]);const n=A();P(n,t,r.start);const d=N(n,p),y=A();return L(y,t,p,-2*d),y}function h(t,r){const c=o(t.start,r),p=o(t.end,r);return{id:t.id,start:c,end:p}}function u([t,r],c){return c[0]>=-t&&c[0]<=t*2&&c[1]>=-r&&c[1]<=r*2}function s(t,r,c,p,n){const d=[],y=o(r.player.position,c);u(t,y)&&d.push({originalId:"player",originalType:"player",position:y,bounces:p,isVisible:!0,mirrorChain:[...n,c.id],virtualRoom:p});for(const g of r.entities){const f=o(g.position,c);u(t,f)&&d.push({originalId:g.id,originalType:"entity",position:f,bounces:p,isVisible:!0,mirrorChain:[...n,c.id],virtualRoom:p})}for(const g of r.mirrors){if(g.id===c.id)continue;const f=h(g,c),E=A();Z(E,f.start,f.end),$(E,E,.5),(u(t,f.start)||u(t,f.end)||u(t,E))&&d.push({originalId:g.id,originalType:"mirror",position:E,bounces:p,isVisible:!0,mirrorChain:[...n,c.id],virtualRoom:p,mirrorData:{start:R(f.start),end:R(f.end)}})}return d}function e(t,r,c,p,n){const d=[];for(const y of c){if(n.includes(y.id))continue;const g=s(t,r,y,p,n);d.push(...g);const f={player:{...r.player,position:o(r.player.position,y)},entities:r.entities.map(l=>({...l,position:o(l.position,y)})),mirrors:r.mirrors.map(l=>h(l,y))},E=e(t,f,c,p+1,[...n,y.id]);d.push(...E)}return d}function a(t){const r={player:t.player,entities:t.entities,mirrors:t.mirrors};return e(t.bounds,r,t.mirrors,1,[])}i.calculateVirtualImages=a})(B||(B={}));var H;(i=>{function o(t,r){const c=r?Y.trace(t):[];return{...t,rays:c}}i.addRays=o;function h(t,r){const c=r?B.calculateVirtualImages(t):[];return{...t,virtualImages:c}}i.addVirtualImages=h;function u(t,r){const c=o(t,r.showRays);return h(c,r.showVirtualImages)}i.processScene=u;function s(t,{entityId:r,position:c}){if(r==="player")return{...t,player:{...t.player,position:R(c)}};const p=t.entities.findIndex(n=>n.id===r);if(p!==-1){const n=[...t.entities];return n[p]=I.makeEntity(c,`entity_${t.entities.length+1}`),{...t,entities:n}}return t}i.moveEntity=s;function e(t,r){const c=I.makeEntity(r,`entity_${t.entities.length+1}`);return{...t,entities:[...t.entities,c]}}i.addEntity=e;function a(t){const r=document.getElementById("lesson");if(!r){alert("Could not find canvas! This should be impossible");return}const c=new O.Handler(r,y),p=U.make(r);let n={canvas:r,scene:t,inputHandler:c,renderer:p};function d(E){switch(E.type){case"MOVE_ENTITY":{const l=s(n.scene,E);n.inputHandler.updateEntities(I.getAllEntities(l),l.player),n={...n,scene:l};break}case"ADD_OBJECT":{const l=C(400,250),m=e(n.scene,l);n.inputHandler.updateEntities(I.getAllEntities(m),m.player),n={...n,scene:m};break}case"RUN_SIMULATION":{console.log("Running simulation...");break}case"REFRESH_SCENE":{const l={...t};n.inputHandler.updateEntities(I.getAllEntities(l),l.player),n={...n,scene:l};break}case"SELECT_ENTITY":break;case"DESELECT_ALL":break;case"START_DRAG":break;case"UPDATE_DRAG":break;case"END_DRAG":break;default:console.error("Unreachable case!",E)}}function y(E){E.forEach(T=>{d(T),n.inputHandler.updateState(T)});const l={showRays:n.inputHandler.getShowRays(),showVirtualImages:n.inputHandler.getShowVirtualImages()},m=u(n.scene,l);n.renderer.render(m,n.inputHandler.getSelectedEntity(),n.inputHandler.getDragState(),n.inputHandler.getDragPreviewPosition())}n.inputHandler.updateEntities(I.getAllEntities(n.scene),n.scene.player);const g={showRays:n.inputHandler.getShowRays(),showVirtualImages:n.inputHandler.getShowVirtualImages()},f=u(n.scene,g);n.renderer.render(f,n.inputHandler.getSelectedEntity(),n.inputHandler.getDragState(),n.inputHandler.getDragPreviewPosition())}i.run=a})(H||(H={}));function J(){const i=V.make().addPlayer([400,300]).addEntity([375,264]).addEntity([400,250]).addMirror([300,200],[300,400]).addMirror([500,200],[500,400]).build();H.run(i)}J();
